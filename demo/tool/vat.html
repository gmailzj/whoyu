<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex, nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/bootstrap@4.1.3/dist/css/bootstrap.css" />
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
    <script src="https://unpkg.com/jquery@1.11.2/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.14.1/dist/xlsx.full.min.js"></script>


    <style>
        .wrapper {
            width: 80%;
            margin: 10px auto;
        }
        
        .upload-demo {
            width: 360px;
        }
        
        .mr_u_d {
            margin: 5px
        }
    </style>
</head>

<body>
    <div class="wrapper">

        <div class="upload-demo">
            <div>
                <span class="el-tag el-tag--success el-tag--small mr_u_d">报税计算工具<!----></span>
            </div>
            <div tabindex="0" class="el-upload el-upload--text dragFile">
                <div class="el-upload-dragger">
                    <i class="el-icon-upload"></i>

                    <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                </div>
                <input type="file" name="file" class="el-upload__input" />
            </div>
            <div class="el-upload__tip">只能上传税务文件(excel+txt)</div>
        </div>
        <!-- <div class="form-group">
            <input type="file" class="form-control-file" id="exampleFormControlFile1" onchange="importf(this)" />
        </div> -->
        <div>
            当前条件为 'BO'列中选择值为"DE", 然后 'AZ'列 求和
        </div>
        <div id="demo"></div>
        <button class="btn btn-primary">计算</button>
    </div>
</body>
<script>
    var workbook; //读取完成的数据
    var rABS = true; //是否将文件读取为二进制字符串

    function importHandler(files) {
        //导入
        if (!files) {
            return;
        }
        var f = files[0];
        console.log(f)
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = e.target.result;
                if (rABS) {
                    workbook = XLSX.read(btoa(fixdata(data)), {
                        //手动转化
                        type: "base64"
                    });
                } else {
                    workbook = XLSX.read(data, {
                        type: "binary"
                    });
                }
            } catch (e) {
                console.error("文件类型不正确");
                return;
            }
            // check column
            if (workbook.Sheets.length > 1) {
                alert("只能有1个工作表Sheets");
                return false;
            }
            var firstSheetNames = workbook.SheetNames[0];
            var fromTo = workbook.Sheets[firstSheetNames]["!ref"];
            console.log(fromTo);
            console.log(workbook.Sheets);
            //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
            //wb.Sheets[Sheet名]获取第一个Sheet的数据
            var contentJson = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetNames]);
            var dataFiltered;
            var sum = 0;
            if (contentJson) {
                console.log(contentJson.length)
                dataFiltered = contentJson.filter(filterHandler)
                dataFiltered.forEach(function(val, key) {
                    if (typeof val['TOTAL_ACTIVITY_VALUE_AMT_VAT_INCL'] != "undefined") {
                        sum += parseFloat(val["TOTAL_ACTIVITY_VALUE_AMT_VAT_INCL"]);
                    }

                })
            }
            var html = "TOTAL_ACTIVITY_VALUE_AMT_VAT_INCL= " + sum;
            document.getElementById("demo").innerHTML = html;
        };
        if (rABS) {
            reader.readAsArrayBuffer(f);
        } else {
            reader.readAsBinaryString(f);
        }
    }

    function filterHandler(val) {
        if (!val) {
            return false
        }
        if (typeof val["SALE_DEPART_COUNTRY"] == "undefined") {
            return false
        }
        if (val["SALE_DEPART_COUNTRY"].toUpperCase() == "DE") {
            return true;
        }
        return false;
    }

    function fixdata(data) {
        //文件流转BinaryString
        var o = "",
            l = 0,
            w = 10240;
        for (; l < data.byteLength / w; ++l)
            o += String.fromCharCode.apply(
                null,
                new Uint8Array(data.slice(l * w, l * w + w))
            );
        o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
        return o;
    }

    $(function() {
        $(".el-upload__input").on("change", function(e) {
            var obj = e.target;
            importHandler(obj.files);
            console.log(e.target, obj.files)
        })
        $(".el-upload").on("click", ".el-upload__text", function(e) {
            $(".el-upload__input").trigger("click")
            return false;
        })

        $(".dragFile").on("dragenter", function(e) {
            e.preventDefault();
        });
        $('.dragFile').on('dragover', (e) => {
            e.preventDefault();
        })
        $('.dragFile').on('drop', (e) => {
            e.stopPropagation();
            e.preventDefault();
            console.log(e)
            var files = e.originalEvent.dataTransfer.files;
            // var files = e.dataTransfer || e.originalEvent.dataTransfer; //获取文件
            console.log(e, files)
            importHandler(files);
            // appendFile(files, '.list-drag')
        })

    })
</script>

</html>